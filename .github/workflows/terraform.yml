name: Deploy Lambda (tarefas)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: sa-east-1
  ARTIFACTS_BUCKET: gestao-tarefas-dev-artifacts-calabria1-sa-east-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do reposit贸rio
        uses: actions/checkout@v4

      - name: Debug da estrutura (pra achar o src)
        run: |
          set -euo pipefail
          echo "PWD=$(pwd)"
          echo "Raiz:"
          ls -la
          echo "rvore (2 n铆veis):"
          find . -maxdepth 2 -type d -print

      - name: Configurar credenciais AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build do ZIP da Lambda (autodetect)
        run: |
          set -euo pipefail

          ARTIFACT_VERSION="${GITHUB_SHA:0:7}"
          echo "ARTIFACT_VERSION=$ARTIFACT_VERSION" >> $GITHUB_ENV

          ROOT="$(pwd)"
          OUT_DIR="$ROOT/build"
          PKG_DIR="$ROOT/.package/tarefas"

          rm -rf "$OUT_DIR" "$PKG_DIR"
          mkdir -p "$OUT_DIR" "$PKG_DIR"

          #  Encontra a pasta onde est谩 o handler.py
          HANDLER_PATH="$(find . -type f -name 'handler.py' | head -n 1 || true)"
          if [ -z "$HANDLER_PATH" ]; then
            echo "N茫o encontrei handler.py no reposit贸rio. Verifique o caminho do c贸digo."
            exit 1
          fi

          SRC_DIR="$(dirname "$HANDLER_PATH")"
          echo "Usando SRC_DIR=$SRC_DIR"

          #  Procura requirements.txt (prioriza o mais pr贸ximo do src)
          REQ_FILE=""
          if [ -f "$SRC_DIR/requirements.txt" ]; then
            REQ_FILE="$SRC_DIR/requirements.txt"
          elif [ -f "$(dirname "$SRC_DIR")/requirements.txt" ]; then
            REQ_FILE="$(dirname "$SRC_DIR")/requirements.txt"
          elif [ -f "requirements.txt" ]; then
            REQ_FILE="requirements.txt"
          fi

          python -m pip install --upgrade pip
          if [ -n "$REQ_FILE" ]; then
            echo "Instalando depend锚ncias de: $REQ_FILE"
            python -m pip install -r "$REQ_FILE" -t "$PKG_DIR"
          else
            echo "Nenhum requirements.txt encontrado. Empacotando apenas o c贸digo."
          fi

          # Copia o c贸digo do src para dentro do pacote
          cp -R "$SRC_DIR/"* "$PKG_DIR/"

          # Gera o zip
          (cd "$PKG_DIR" && zip -qr "$OUT_DIR/tasks.zip" .)

          echo "ZIP gerado: $OUT_DIR/tasks.zip"
          ls -lh "$OUT_DIR/tasks.zip"

      - name: Upload do ZIP para o S3
        run: |
          set -euo pipefail
          aws s3 cp build/tasks.zip "s3://${{ env.ARTIFACTS_BUCKET }}/lambdas/tasks/${ARTIFACT_VERSION}.zip"
          aws s3 cp build/tasks.zip "s3://${{ env.ARTIFACTS_BUCKET }}/lambdas/tasks/latest.zip"
