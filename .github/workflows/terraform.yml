name: Deploy (todo-api -> AWS dev)

on:
  push:
    branches: [main]
    paths:
      - "services/**"
      - ".github/workflows/deploy-dev.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: sa-east-1
  ARTIFACTS_BUCKET: todo-calabrial-artifacts-123
  TF_WORKING_DIR: todo-infra/todo-infra/infra/envs/dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout do repo atual (todo-api)
      - name: Checkout todo-api
        uses: actions/checkout@v4

      # 2) Checkout do repo todo-infra (PUBLICO)
      - name: Checkout todo-infra
        uses: actions/checkout@v4
        with:
          repository: escoladoestudante/todo-infra
          ref: main
          path: todo-infra
          fetch-depth: 1

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3) Build ZIP da lambda (limpo) com deps
      - name: Build Lambda package (tasks)
        run: |
          set -euo pipefail

          SRC_DIR="services/tasks/src"
          REQ_FILE="services/tasks/requirements.txt"

          rm -rf build
          mkdir -p build/lambda

          # copia código (handler.py precisa ficar na raiz do zip)
          rsync -av --exclude '__pycache__' --exclude '*.pyc' "${SRC_DIR}/" build/lambda/

          # instala deps no build/lambda
          python -m pip install --upgrade pip
          if [ -f "${REQ_FILE}" ]; then
            pip install -r "${REQ_FILE}" -t build/lambda
          else
            echo "requirements.txt nao encontrado em ${REQ_FILE}"
          fi

          # cria zip
          (cd build/lambda && zip -r "../tasks.zip" .)
          ls -lh build/tasks.zip
          
      # 4) Upload para S3 usando a versão = GITHUB_SHA (igual ao TF_VAR)
      - name: Upload Lambda artifact to S3
        run: |
          set -euo pipefail
          aws s3 cp build/tasks.zip \
            "s3://${ARTIFACTS_BUCKET}/lambdas/tasks/${GITHUB_SHA}.zip"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.6"

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      # 5) APPLY apontando a lambda pra esse zip novo
      - name: Terraform apply (update lambda)
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          TF_VAR_lambda_artifact_version: ${{ github.sha }}
        run: terraform apply -auto-approve
